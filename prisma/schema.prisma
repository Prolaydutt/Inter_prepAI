// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  username       String    @unique
  hashedPassword String
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())

  // One user can have many interview sessions
  sessions       InterviewSession[]
  codeSubmissions CodeSubmission[]
  proctoringEvents  ProctoringEvent[]
  cheatingReports   CheatingReport[]


  @@map("users")  // actual table name in PostgreSQL
}

model Role {
  id          Int       @id @default(autoincrement())
  name        String    @unique   // e.g. 'SDE', 'ML_ENGINEER'
  description String?

  questions   Question[]
  sessions    InterviewSession[]
  codingProblems  CodingProblem[]

  @@map("roles")
}

model Question {
  id          Int      @id @default(autoincrement())
  roleId      Int
  content     String
  difficulty  String   @default("medium")  // easy | medium | hard
  topic       String?  // DSA | System Design | HR | ML
  idealAnswer String?

  role        Role     @relation(fields: [roleId], references: [id])

  @@map("questions")
}

model InterviewSession {
  id                   Int      @id @default(autoincrement())
  userId               Int
  roleId               Int
  status               String   @default("IN_PROGRESS")  // IN_PROGRESS | COMPLETED
  currentQuestionIndex Int      @default(0)
  startedAt            DateTime @default(now())
  endedAt              DateTime?

  user   User @relation(fields: [userId], references: [id])
  role   Role @relation(fields: [roleId], references: [id])
  answers  InterviewAnswer[]
  proctoringEvents  ProctoringEvent[]
  cheatingReport    CheatingReport?


  @@map("interview_sessions")
}

model InterviewAnswer {
  id           Int      @id @default(autoincrement())
  sessionId    Int
  questionText String
  transcript   String   // raw text from Whisper
  audioPath    String?  // path to stored audio file
  score        Float?   // cosine similarity score (added in Week 6)
  feedback     String?  // AI feedback (added in Week 6)
  createdAt    DateTime @default(now())

  session      InterviewSession @relation(fields: [sessionId], references: [id])

  @@map("interview_answers")
}

model CodingProblem {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  difficulty  String   @default("medium")  // easy | medium | hard
  topic       String?  // DSA | Arrays | Trees | DP
  roleId      Int?
  timeLimit   Int      @default(5000)       // milliseconds
  memoryLimit Int      @default(128)        // MB
  starterCode Json                          // { python: "...", javascript: "...", cpp: "..." }
  createdAt   DateTime @default(now())

  testCases   TestCase[]
  submissions CodeSubmission[]
  role        Role?    @relation(fields: [roleId], references: [id])

  @@map("coding_problems")
}

model TestCase {
  id        Int    @id @default(autoincrement())
  problemId Int
  input     String
  expected  String
  isHidden  Boolean @default(true)   // hidden = not shown to user
  points    Int     @default(10)

  problem   CodingProblem @relation(fields: [problemId], references: [id])

  @@map("test_cases")
}

model CodeSubmission {
  id              Int      @id @default(autoincrement())
  userId          Int
  sessionId       Int?
  problemId       Int
  language        String   // python | javascript | cpp
  code            String
  status          String   @default("PENDING")  // PENDING | RUNNING | ACCEPTED | WRONG_ANSWER | TLE | ERROR
  score           Float?
  passedCases     Int      @default(0)
  totalCases      Int      @default(0)
  runtime         Int?     // milliseconds
  memoryUsed      Int?     // MB
  complexityScore String?  // O(n) | O(n^2) | O(log n)
  errorMessage    String?
  createdAt       DateTime @default(now())

  user    User          @relation(fields: [userId], references: [id])
  problem CodingProblem @relation(fields: [problemId], references: [id])

  @@map("code_submissions")
}

model ProctoringEvent {
  id        Int      @id @default(autoincrement())
  sessionId Int
  userId    Int
  eventType String
  // Event types:
  // TAB_SWITCH    — user switched to another browser tab
  // WINDOW_BLUR   — user clicked outside the browser window
  // WINDOW_FOCUS  — user returned to the browser window
  // COPY          — user copied text
  // PASTE         — user pasted text
  // PASTE_SPIKE   — large paste detected (>50 chars at once)
  // IDLE          — no typing for more than 30 seconds
  // RAPID_TYPING  — typing speed suddenly jumped (possible paste)
  metadata  Json?    // extra data: { charCount, wpm, duration }
  timestamp DateTime @default(now())

  session   InterviewSession @relation(fields: [sessionId], references: [id])
  user      User             @relation(fields: [userId],    references: [id])

  @@map("proctoring_events")
}

model CheatingReport {
  id                Int      @id @default(autoincrement())
  sessionId         Int      @unique
  userId            Int
  // Individual signal scores (0-100 each)
  tabSwitchScore    Float    @default(0)
  pasteScore        Float    @default(0)
  idleScore         Float    @default(0)
  typingScore       Float    @default(0)
  similarityScore   Float    @default(0)
  // Final weighted score
  overallRisk       Float    @default(0)
  riskLevel         String   @default("LOW")  // LOW | MEDIUM | HIGH | CRITICAL
  summary           String?
  createdAt         DateTime @default(now())

  session   InterviewSession @relation(fields: [sessionId], references: [id])
  user      User             @relation(fields: [userId],    references: [id])

  @@map("cheating_reports")
}
